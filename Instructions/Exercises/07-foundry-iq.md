---
lab:
  title: Microsoft Foundry で Foundry IQ の使用を開始する
  description: Foundry IQ を使用して、エージェントをナレッジに接続します。
  level: 100
  duration: 20 minutes
---

# Microsoft Foundry で Foundry IQ の使用を開始する

Contoso Corp の人事部門は、従業員のサポート作業を減らし、人事のポリシーと手続きに関するクエリのためのセルフサービス ソリューションを提供することで従業員を支援したいと考えています。

この演習では、Microsoft Foundry IQ を使用して、人事ドキュメントに含まれるナレッジを使用して人事関連の問題について従業員にアドバイスする AI エージェントを作成します。

この演習の所要時間は約 **20** 分です。

> **注**:この演習を完了するには、必要なリソースを作成するための十分なアクセス許可を持つ Azure サブスクリプションの資格情報が必要です。

## データ ソースを設定する

まず、人事のポリシーと手続きのドキュメント用にエンタープライズ データ ソースを設定します。 このシナリオでは、Contoso Corp. の人事部門が Azure AI 検索を使用して人事ドキュメントのインデックスを作成し、簡単に検索できるようにします。

> **注**:簡略化のため、この演習では 1 つの Azure AI 検索リソースを使用します。 これが実際のボリュームや多様なデータを表すものではないのは明らかですが、原則を説明するには役立ちます。

1. Web ブラウザーで、[Azure portal](https://portal.azure.com){:target="_blank"} (`https://portal.azure.com`) を開きます。 メッセージが表示されたら、Azure 資格情報を使用してサインインします。

   ウェルカム通知を閉じて、Azure portal のホーム ページを表示します。

1. ページ上部の検索バーの右側にある **[\>_]** ボタンを使用して、Azure portal に新しい Cloud Shell を作成し、サブスクリプションにストレージがない ***Bash*** 環境を選択します。

    Azure portal の下部にあるペインに Cloud Shell のコマンド ライン インターフェイスが表示されます。 作業しやすくするために、このウィンドウのサイズを変更したり最大化したりすることができます。

    > **注**: *PowerShell* 環境を使用するクラウド シェルを以前に作成している場合は、それを ***Bash*** に切り替えること。

1. Cloud Shell ペインで、次のコマンドを入力して、この演習のコード ファイルを含む GitHub リポジトリをクローンします (コマンドを入力するか、クリップボードにコピーしてから、コマンド ラインで右クリックし、プレーンテキストとして貼り付けます)。

    ```
   rm -r labfiles -f
   git clone https://github.com/microsoftlearning/mslearn-ai-fundamentals labfiles
   cd labfiles/setup

    ```

1. リポジトリがクローンされたら、次のコマンドを入力して、必要なリソースをデプロイするセットアップ スクリプトを実行します。

    ```
   bash ./deploy-search.sh
    
    ```

1. メッセージが表示されたら、次を入力します。
    - Azure AI 検索をデプロイするリソース グループ
    - Azure AI 検索をデプロイするリージョン
    - Azure AI 検索リソースの一意の名前

1. スクリプトで Azure AI 検索がデプロイされ、この演習で使用するインデックスが作成されるまで待ちます。
1. スクリプトが完了したら、Cloud Shell ペインを閉じ、Azure portal ホーム ページで **[リソース グループ]** を選択します。 次に、指定したリソース グループを開き、指定した名前の Azure AI 検索リソースが含まれていることを確認します。

## AI エージェントを作成する

必要なインフラストラクチャが整うと、従業員の質問に対する応答を人事ドキュメントで検索できる AI エージェントを作成する準備ができています。

1. Web ブラウザーで [Microsoft Foundry](https://ai.azure.com){:target="_blank"} (`https://ai.azure.com`) を開き、Azure の資格情報を使ってサインインします。 初めてサインインすると開くヒントやクイック スタートのペインをすべて閉じ、必要な場合は、左上にある **Foundry** のロゴを使ってホーム ページに移動します。
1. まだ有効になっていない場合は、ページ上部のツール バーで **[新しい Foundry]** オプションを有効にします。 次に、メッセージが表示されたら、新しいプロジェクトを一意の名前で作成します。Azure AI 検索をデプロイしたリソース グループにプロジェクトをデプロイするための **[詳細設定オプション]** 領域が展開します。

     新しい Foundry ポータルでプロジェクトを作成すると、次の画像のようなページが開きます。

    ![AI Foundry プロジェクトのホーム ページのスクリーンショット。](./media/0-foundry-project.png)
から始めます。

1. **[ビルドの開始]** メニューで **[エージェントの作成]** を選択し、メッセージが表示されたら、エージェントに **hr-Agent** という名前を付けます。

     準備ができると、エージェントがエージェント プレイグラウンドで開きます。

    ![エージェント プレイグラウンドのスクリーンショット。](./media/hr-agent.png)

1. モデルのドロップダウン リストで、**gpt-4.1** モデルがデプロイされ、エージェント用に選択されていることを確認します。
1. エージェントに次の**指示**を割り当てます。

    ```
   You are an AI agent in the HR department of Contoso Corp. You answer employee questions about HR policies and processes. Always respond politely and professionally. Do not engage in conversations beyond the subject of HR policies and processes.
    ```

1. **[保存]** ボタンを押して、変更を保存します。
1. **[チャット]** ペインに次のプロンプトを入力して、エージェントをテストします。

    ```
   What can you help me with?
    ```

    エージェントは、指示に基づいた適切な応答で返信する必要があります。

1. このプロンプトを試してみましょう。

    ```
   What is the capital of France?
    ```

    エージェントが、ヨーロッパの首都に関する会話に関与すべきではありません。 トピックを人事のポリシーと手続きにリダイレクトする必要があります。

1. 次にこれを試してみます。

    ```
   How many vacation days do employees get?
    ```

    エージェントは、正しい応答の*ように見える*もので応答する場合があります。 ただし、エージェントには現在、Contoso の人事のポリシーと手続きに関するナレッジがないため、応答が正確な情報に典拠していません。

    これを修正しましょう。

## Foundry IQ のナレッジ ベースを追加する

Foundry IQ は、エージェントがナレッジ ベースとして使用できるデータ ソースの一元的な接続ポイントです。 複数のエージェントが使用できるナレッジのコレクションを作成および管理できます。エージェントごとにデータ アクセスとクエリ ロジックをコーディングする必要はありません。

### Foundry IQ を構成する

1. プレイグラウンドの左側のペインで、**[ナレッジ]** を展開します。 次に、**[追加]** の一覧で **[Foundry IQ に接続]** を選択します。

    検索リソースに接続するように求めるメッセージが表示されます。

    ![[Foundry IQ に接続] ダイアログのスクリーンショット。](./media/connect-foundry-iq.png)

1. **[AI 検索リソースに接続]** を選択して、[Foundry IQ] ページを開きます。 次に、使用可能な AI 検索リソースの一覧で、Azure AI 検索リソースを選択し、認証の種類に **[API キー]** を指定します。

    ![AI 検索リソースが選択されている Foundry IQ ページのスクリーンショット。](./media/foundry-iq-search.png)

    > **重要**: 運用ソリューションでは、通常、Microsoft Entra ID 認証を使用する必要があります。 この演習では、便宜上キーベースの認証を使用しています。

1. Azure AI 検索リソースを接続します。 しばらくすると開き、そこにナレッジ ベースを作成できるようになります。

    ![ナレッジ ベースのページのスクリーンショット。](./media/knowledge-bases.png)

    > **注**:Foundry IQ のナレッジ ストアをサポートできるように、Foundry プロジェクトに Azure AI 検索リソースを追加しています。 Foundry IQ は<u>*常に*</u> Azure AI 検索リソースを使用して、アクセスしているデータの場所に関係なく、1 つ以上のナレッジ ベースのベクトル インデックスを作成することを理解しておくことが重要です。 この場合、データが Azure AI 検索インデックスにある場合もありますが、データ レイク、SharePoint サイト、その他の場所にある場合でも、Azure AI 検索リソースを Foundry プロジェクトにアタッチする必要があります。

### ナレッジ ベースの作成

1. **[ナレッジ ベースの作成]** を選択し、使用可能なナレッジ ベースの種類を表示します。 これらは、Foundry IQ のナレッジ ベースに使用できるさまざまな種類のデータ ソースを表します。 

    ![ナレッジ ベースの種類のスクリーンショット。](./media/knowledge-base-types.png)

1. **[Azure AI 検索インデックス]** および **[接続]** を選択します。

1. メッセージが表示されたら、Azure AI 検索リソースの **hr-index** に基づいて、適切な説明を含む `hr-documentation` という名前のナレッジ ソースを作成します。 

    ![[ナレッジ ソースの作成] ページのスクリーンショット。](./media/create-knowledge-source.png)

1. ナレッジ ソースを追加したら、次の値を割り当ててナレッジ ベースの構成を完了します。
    - **名前**: `contoso-corporate-data`
    - **説明**: `Corporate documentation for employees`
    - **[チャット入力候補モデル]**: gpt-4.1
    - **[取得の推論作業]**:低
    - **[出力モード]**:応答の合成
    - **[応答の指示]**: `Answer concisely, based on the available context`
    - **[取得の指示]**: `Use the hr-documentation source for all questions related to HR policies and procedures`

    ![[ナレッジ ベースの作成] ページのスクリーンショット。](./media/create-knowledge-base.png)

    > **注**:*[出力モード]* は、Foundry IQ がエージェントにナレッジを返す方法を決定します。 *[抽出データ]* はナレッジ ソースから逐語的テキストを返し、*[応答の合成]* は生成 AI モデルを使用して適切な応答を作成します。 *[応答の指示]* は、応答の書式を指定するシステム プロンプトとして機能し、*[取得の指示]* は Foundry IQ が使用可能なナレッジ ベースでナレッジをどのように検索するかを指示します (この場合、ナレッジ ベースは 1 つだけですが、さらに多い場合があります)。

1. ナレッジ ストアを保存します。

## 人事エージェントでナレッジ ストアを使用する

これで、人事エージェントで新しいナレッジ ストアを使用する準備ができました。

1. ナレッジ ストアを保存したら、**[エージェント内で使用する]** ドロップダウン リストで人事エージェントを選択します。

    エージェント プレイグラウンドでエージェントが開き、ナレッジ ストアがアタッチされています。

1. チャット ペインで、次のクエリを入力します。

    ```
   How many vacation days do employees get?
    ```

    Foundry IQ を使用してその応答のコンテキストを見つける必要があるとエージェントが判断した場合は、アクセスを承認するように求められます。 エージェントのツール アクセスの制御方法を選択できます (一度だけ、常に、またはすべてのツールを承認する)。 

    ![承認プロンプトのスクリーンショット。](./media/allow-foundry-iq.png)

1. エージェントからの応答で、応答の下部に *kb_contoso_corporate_d_a12bc* のような名前のナレッジ ベースが引用されていることを確認してください。これで、エージェントが Foundry IQ で作成したナレッジ ソースを使用したことを確認できます。

### 従業員向けのエージェント UI をプレビューする

従業員は、会社の社内人事サイトの Web アプリケーションを通じてエージェントを使用することになります。 運用環境での外観と動作を見てみましょう。

1. エージェント プレイグラウンドの上部にある **[プレビュー]** の一覧で、**[エージェントのプレビュー]** を選択します。

    エージェントが新しいブラウザー タブで開きます。

1. 次のプロンプトを入力します。

    ```
   How do I request PTO?
    ```

    メッセージが表示されたら、ツールへのアクセスを承認し、応答を確認します。

    ![エージェントのプレビューのスクリーンショット。](./media/preview-hr-agent.png)

1. 他の人事トピック (リモートまたはハイブリッドの勤務ポリシー、従業員の福利厚生など) について質問してみてください。

## まとめ

この演習では、Foundry IQ を使用してエージェントをナレッジ ソースに接続する方法について説明しました。 この演習の例はシンプルですが、応答の精度と関連性を高めるために、エージェントがコンテキスト ナレッジを典拠とできることが示されています。

Foundry IQ を使用すると、生成 AI ソリューションで普及している検索拡張生成 (RAG) パターンのカスタム実装よりも多くの利点があります。 ナレッジへのアクセスを 1 つのツールに一元化することで、データ ソースの選択と取得ロジックを Foundry IQ にオフロードでき、コードやデータ アクセス ロジックを複製することなく、複数のエージェント間でナレッジ ソースを再利用できます。

## クリーンアップ

Microsoft Foundry について調べ終わったら、不要な利用料金が発生しないように、この演習で作成したリソースを削除する必要があります。

1. [Azure portal](https://portal.azure.com){:target="_blank"} (`https://portal.azure.com`) を開き、この演習で使ったプロジェクトをデプロイしたリソース グループの内容を表示します。
1. ツール バーの **[リソース グループの削除]** を選びます。
1. リソース グループ名を入力し、削除することを確認します。